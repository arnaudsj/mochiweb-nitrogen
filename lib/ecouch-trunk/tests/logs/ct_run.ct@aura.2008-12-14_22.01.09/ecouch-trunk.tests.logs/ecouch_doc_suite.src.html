<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head><title>/Library/Erlang/Libs/ecouch-trunk/tests/test/ecouch_doc_SUITE.erl</title></head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
    1:-<b>module</b>(ecouch_doc_SUITE).
    2:-<b>compile</b>(export_all).
    3:
    4:-<b>include_lib</b>("common_test/include/ct.hrl").
    5:
    6:-<b>import</b>(ct).
    7:-<b>import</b>(test_helper).
    8:-<b>import</b>(ecouch).
    9:
<a name="10"></a>   10:<i>% Let's error out if our tests take over a minute to complete. This can be reconfigured</i>
   11:<i>% on a per testcase basis in init_per_testcase.</i>
<a name=suite>   12:<b>suite</b></a>() -&gt; [{timetrap, {minutes, 1}}].
   13:
   14:
<a name=init_per_suite>   15:<b>init_per_suite</b></a>(Config) -&gt;
   16:    ok = application:start(inets),
   17:    ok = application:start(ecouch),
   18:    Config.
   19:    
<a name=end_per_suite><a name="20"></a>   20:<b>end_per_suite</b></a>(_Config) -&gt;
   21:    test_helper:delete("ecouch_ct_test"),
   22:    application:stop(ecouch),
   23:    application:stop(inets),
   24:    ok.
   25:
<a name=init_per_testcase>   26:<b>init_per_testcase</b></a>(_TestCase, Config) -&gt;
   27:    test_helper:recreate_db(),
   28:    Config.
   29:    
<a name=end_per_testcase><a name="30"></a>   30:<b>end_per_testcase</b></a>(_TestCase, Config) -&gt;
   31:    Config.
   32:    
<a name=all>   33:<b>all</b></a>() -&gt; [test_doc_creation_without_id, test_doc_creation_with_id, test_doc_get, test_doc_get_all].
   34:
<a name=test_doc_creation_without_id>   35:<b>test_doc_creation_without_id</b></a>() -&gt;
   36:    [{userdata, {doc, "Creating a document in an existing database."}}].
   37:    
<a name=test_doc_creation_without_id>   38:<b>test_doc_creation_without_id</b></a>(_Config) -&gt;
   39:    ?line {ok, {obj, [{"ok", true}, {"id", BinId}, {"rev", BinRev}]}} = ecouch:doc_create("ecouch_ct_test", {obj, [{"foo", 1}]}),
<a name="40"></a>   40:
   41:    ?line {ok, {{_, 200, _}, _, Body}} = test_helper:get("ecouch_ct_test", binary_to_list(BinId)),
   42:    
   43:    ?line {ok, {obj, [{"_id", BinId}, {"_rev", BinRev}, {"foo", 1}]}, []} = rfc4627:decode(Body),
   44:    ok.
   45:
<a name=test_doc_creation_with_id>   46:<b>test_doc_creation_with_id</b></a>() -&gt;
   47:    [{userdata, {doc, "Creating a document in an existing database with an id given"}}].
   48:    
<a name=test_doc_creation_with_id>   49:<b>test_doc_creation_with_id</b></a>(_Config) -&gt;
<a name="50"></a>   50:    ?line {ok, {obj, [{"ok", true}, {"id", BinId}, {"rev", BinRev}]}} = 
   51:        ecouch:doc_create("ecouch_ct_test", "foo_has_one", {obj, [{"foo", 1}]}),
   52:        
   53:    ?line "foo_has_one" = binary_to_list(BinId), % Make sure the id was set correctly
   54:    
   55:    ?line {ok, {{_, 200, _}, _, Body}} = test_helper:get("ecouch_ct_test", "foo_has_one"),
   56:    ?line {ok, {obj, [{"_id", BinId}, {"_rev", BinRev}, {"foo", 1}]}, []} = rfc4627:decode(Body),
   57:    ok.
   58:    
<a name=test_doc_get>   59:<b>test_doc_get</b></a>() -&gt;
<a name="60"></a>   60:    [{userdata, {doc, "Grabbing a document from an existing database"}}].
   61:    
<a name=test_doc_get>   62:<b>test_doc_get</b></a>(_Config) -&gt;
   63:    Body = {obj, [{"foo", 2}]},
   64:    JsonBody = rfc4627:encode(Body),
   65:    ?line {ok, {{_, 201, _}, _, _}} = test_helper:put("ecouch_ct_test", "foo_has_two", JsonBody),
   66:    ?line {ok, {obj, [{"_id", &lt;&lt;"foo_has_two"&gt;&gt;}, {"_rev", _}, {"foo", 2}]}} = ecouch:doc_get("ecouch_ct_test", "foo_has_two").
   67:    
<a name=test_doc_get_all>   68:<b>test_doc_get_all</b></a>() -&gt;
   69:    [{userdata, {doc, "Get all of the documents from an existing database."}}].
<a name=test_doc_get_all><a name="70"></a>   70:<b>test_doc_get_all</b></a>(_Config) -&gt;
   71:    JsonBody1 = rfc4627:encode({obj, [{"foo", 1}]}),
   72:    JsonBody2 = rfc4627:encode({obj, [{"foo", 2}]}),
   73:    
   74:    test_helper:get("right_here_fool"),
   75:    ?line {ok, {{_, 201, _}, _, _}} = test_helper:put("ecouch_ct_test", "foo_has_one", JsonBody1),
   76:    ?line {ok, {{_, 201, _}, _, _}} = test_helper:put("ecouch_ct_test", "foo_has_two", JsonBody2),
   77:    
   78:    ?line {ok, {obj, [{"total_rows", 2}, {"offset", 0}, {"rows", Docs}]}} = ecouch:doc_get_all("ecouch_ct_test"),
   79:    Keys = lists:map(fun({obj, DocProps}) -&gt; proplists:get_value("key", DocProps) end, Docs),
<a name="80"></a>   80:    ?line true = lists:member(&lt;&lt;"foo_has_one"&gt;&gt;, Keys),
   81:    ?line true = lists:member(&lt;&lt;"foo_has_two"&gt;&gt;, Keys).
   82:    
</pre>
<hr size=1><i>The transformation of this file (83 lines) took 0.00 seconds</i><br>
</body>
</html>
